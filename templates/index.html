<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Textify â€“ File to Text Converter</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="container">
    <section class="hero-card">
      <h1>Textify</h1>
      <p class="subtitle">Convert your PDFs or images into editable text instantly.</p>
    </section>

    <section class="upload-card">
      <form method="POST" enctype="multipart/form-data" class="upload-section">
        <div class="upload-grid">
          <label for="file" class="file-label">Upload File</label>
          <input type="file" name="file" id="file" required hidden>
          <p id="filename" class="filename-box">No file chosen</p>
          <button type="submit" class="convert-btn">Convert</button>
        </div>
      </form>
    </section>

    {% if history %}
    <section class="history-box">
      <h2>History</h2>
      <table class="history-table" id="historyTable">
        {% for item in history %}
        <tr data-index="{{ loop.index0 }}">
          <td><button class="delete-btn" onclick="deleteHistory({{ loop.index0 }})">âœ•</button></td>
          <td class="divider">|</td>
          <td><button class="file-link" onclick="openPreview('{{ item.filename }}')">{{ item.filename }}</button></td>
          <td class="divider">|</td>
          <td><button class="view-history" onclick="openTextModal({{ loop.index0 }})">View</button></td>
        </tr>
        {% endfor %}
      </table>
    </section>
    {% endif %}
  </main>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="modal-content preview-box">
      <iframe id="previewFrame" src="" frameborder="0"></iframe>
      <button id="closePreview" class="close-btn">Close</button>
    </div>
  </div>

  <!-- Text Modals -->
  {% for item in history %}
  <div id="textModal-{{ loop.index0 }}" class="modal">
    <div class="text-modal-box">
      <div class="modal-header">
        <h3>{{ item.filename }}</h3>
        <div class="copy-section">
          <button class="copy-btn" onclick="copyText({{ loop.index0 }})">ðŸ“‹ Copy</button>
          <span id="copied-msg-{{ loop.index0 }}" class="copied-msg">Copied!</span>
        </div>
      </div>
      <textarea id="text-{{ loop.index0 }}" oninput="updateCounts({{ loop.index0 }})">{{ item.text }}</textarea>
      <div class="modal-footer">
        <span id="charCount-{{ loop.index0 }}" class="count left">0 chars</span>
        <span id="wordCount-{{ loop.index0 }}" class="count right">0 words</span>
      </div>
      <button class="close-btn" onclick="closeTextModal({{ loop.index0 }})">Close</button>
    </div>
  </div>
  {% endfor %}

  <script>
    const fileInput = document.getElementById("file");
    const filenameDisplay = document.getElementById("filename");
    const form = document.querySelector("form.upload-section");
    const historyTable = document.getElementById("historyTable");

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      filenameDisplay.textContent = file ? file.name : "No file chosen";
    });

    // --- Prevent duplicate uploads ---
    form.addEventListener("submit", (event) => {
      const file = fileInput.files[0];
      if (!file) return;
      const existingRows = Array.from(historyTable?.querySelectorAll("tr") || []);
      const alreadyExists = existingRows.some(row =>
        row.querySelector(".file-link")?.textContent === file.name
      );
      if (alreadyExists) {
        event.preventDefault();
        alert("This file has already been uploaded.");
      }
    });

    async function deleteHistory(index) {
      const row = document.querySelector(`tr[data-index='${index}']`);
      row.style.transition = "opacity 0.3s ease, transform 0.3s ease";
      row.style.opacity = "0";
      row.style.transform = "scale(0.9)";
      await fetch(`/delete/${index}`, { method: "POST" });
      setTimeout(() => row.remove(), 300);
    }

    function openPreview(filename) {
      const modal = document.getElementById("previewModal");
      const frame = document.getElementById("previewFrame");
      frame.src = `/preview/${filename}`;
      modal.classList.add("show");
      document.querySelector(".container").classList.add("blurred");
    }

    document.getElementById("closePreview").onclick = () => {
      document.getElementById("previewModal").classList.remove("show");
      document.querySelector(".container").classList.remove("blurred");
    };

    function openTextModal(i) {
      const modal = document.getElementById(`textModal-${i}`);
      modal.classList.add("show");
      document.querySelector(".container").classList.add("blurred");
      updateCounts(i);
    }

    function closeTextModal(i) {
      const modal = document.getElementById(`textModal-${i}`);
      modal.classList.remove("show");
      document.querySelector(".container").classList.remove("blurred");
    }

    async function copyText(i) {
      const ta = document.getElementById(`text-${i}`);
      await navigator.clipboard.writeText(ta.value);
      const msg = document.getElementById(`copied-msg-${i}`);
      msg.classList.add("show");
      setTimeout(() => msg.classList.remove("show"), 1000);
    }

    function updateCounts(i) {
      const text = document.getElementById(`text-${i}`).value;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const chars = text.length;
      document.getElementById(`wordCount-${i}`).textContent = `${words} words`;
      document.getElementById(`charCount-${i}`).textContent = `${chars} chars`;
    }
  </script>
</body>
</html>
